import React, { useEffect, useState } from "react";
import {
  Card,
  CardContent,
  CardHeader,
  CardTitle,
} from "@/components/ui/card.jsx";
import { useAuth } from "@/context/useAuth.jsx";
import generateCallsAPI from "@/functions/GestionnaireCallsAPI.jsx";

function Permissions() {
  const { token } = useAuth();
  const [roles, setRoles] = useState(null);
  const [currentRole, setCurrentRole] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [toutDroits, setToutDroits] = useState({
    Defaut: [
      [
        "Savon",
        [
          {
            libelle: "droit1",
            description: "Description droit1",
            active: true,
          },
          {
            libelle: "droit2",
            description: "Description droit2",
            active: false,
          },
        ],
      ],
      [
        "Gestion de l'aire",
        [
          {
            libelle: "droit3",
            description: "Description droit3",
            active: false,
          },
          {
            libelle: "droit4",
            description: "Description droit4",
            active: true,
          },
        ],
      ],
    ],
    Gestionnaire: [
      [
        "Savon",
        [
          {
            libelle: "droit1",
            description: "Description droit1",
            active: true,
          },
          {
            libelle: "droit2",
            description: "Description droit2",
            active: false,
          },
        ],
      ],
      [
        "Gestion de l'aire",
        [
          {
            libelle: "droit3",
            description: "Description droit3",
            active: false,
          },
          {
            libelle: "droit4",
            description: "Description droit4",
            active: true,
          },
        ],
      ],
    ],
    Entretien: [
      [
        "Savon",
        [
          {
            libelle: "droit1",
            description: "Description droit1",
            active: true,
          },
          {
            libelle: "droit2",
            description: "Description droit2",
            active: false,
          },
        ],
      ],
      [
        "Gestion de l'aire",
        [
          {
            libelle: "droit3",
            description: "Description droit3",
            active: false,
          },
          {
            libelle: "droit4",
            description: "Description droit4",
            active: true,
          },
        ],
      ],
    ],
    "Admin Entretien": [
      [
        "Savon",
        [
          {
            libelle: "droit1",
            description: "Description droit1",
            active: true,
          },
          {
            libelle: "droit2",
            description: "Description droit2",
            active: false,
          },
        ],
      ],
      [
        "Gestion de l'aire",
        [
          {
            libelle: "droit3",
            description: "Description droit3",
            active: false,
          },
          {
            libelle: "droit4",
            description: "Description droit4",
            active: true,
          },
        ],
      ],
    ],
    "Admin Gestion": [
      [
        "Savon",
        [
          {
            libelle: "droit1",
            description: "Description droit1",
            active: true,
          },
          {
            libelle: "droit2",
            description: "Description droit2",
            active: false,
          },
        ],
      ],
      [
        "Gestion de l'aire",
        [
          {
            libelle: "droit3",
            description: "Description droit3",
            active: false,
          },
          {
            libelle: "droit4",
            description: "Description droit4",
            active: true,
          },
        ],
      ],
    ],
    "Super Admin": [
      [
        "Savon",
        [
          {
            libelle: "droit1",
            description: "Description droit1",
            active: true,
          },
          {
            libelle: "droit2",
            description: "Description droit2",
            active: true,
          },
        ],
      ],
      [
        "Gestion de l'aire",
        [
          {
            libelle: "droit3",
            description: "Description droit3",
            active: true,
          },
          {
            libelle: "droit4",
            description: "Description droit4",
            active: true,
          },
        ],
      ],
    ],
  });
  const [droits, setDroits] = useState(null);
  const nomCategorie = {
    users: "Utilisateures",
    roles: "Rôles",
    permissions: "Permissions",
    admin: "Administrateur",
  };
  // const [infos, setInfos] = useState([]);

  async function getRoles() {
    return generateCallsAPI(token, "GET", "/api/roles/all");
  }

  async function getRoleById(idRole) {
    return generateCallsAPI(token, "GET", "/api/roles/" + idRole);
  }

  async function getDroits(role) {
    return generateCallsAPI(
      token,
      "GET",
      "/api/roles/" + role + "/permissions",
    );
  }

  function updateDroit(idDroit, idRole, active) {
    // POST : Update droit pour le role en BDD
    void generateCallsAPI(token, "POST", "/api/roles/permissions/update", {
      idDroit: idDroit,
      idRole: idRole,
      active: active,
    });
  }

  function updateRole(idRole) {
    const newRole = getRoleById(idRole);
  }

  useEffect(() => {
    async function fetchData() {
      let tempRoles = roles;
      let tempDroits = droits;
      let tempCurrentRole = currentRole;
      if (tempRoles === null) {
        tempRoles = await getRoles();
      }
      if (
        currentRole === null &&
        (tempRoles !== null || roles !== null) &&
        tempDroits === null
      ) {
        const futurRole = tempRoles !== null ? tempRoles[0] : roles[0];
        tempCurrentRole = futurRole;
        tempDroits = await getDroits(futurRole._id);
      } else if (currentRole !== null && tempDroits === null) {
        tempDroits = await getDroits(currentRole._id);
      }
      await setRoles(tempRoles);
      await setCurrentRole(tempCurrentRole);
      await setDroits(tempDroits);
      await setIsLoading(false);
    }
    void fetchData();
  }, [currentRole]);

  if (isLoading) {
    return <div>Chargement...</div>;
  }

  return (
    <div>
      <h2>Roles</h2>
      <div className="flex justify-around">
        {roles !== null
          ? roles.map((role, key) => (
              <Card
                key={key}
                className={
                  currentRole.name === role.name ? "bg-cyan-900 w-fit" : "w-fit"
                }
                onClick={() => {
                  if (currentRole._id !== role._id) {
                    updateRole(role._id);
                  }
                }}
              >
                <div className={"w-fit"}>
                  <CardContent className={"capitalize w-fit"}>
                    {role.name}
                  </CardContent>
                </div>
              </Card>
            ))
          : "Chargement..."}
      </div>
      <h2>Droits</h2>
      <div className={"flex flex-col gap-4"}>
        {droits !== null
          ? droits.map((droitData, key) => (
              <div
                key={key}
                className={
                  "border border-slate-800 p-2 rounded-md bg-slate-600 backdrop-blur"
                }
              >
                <h2 className={"pb-4"}>{nomCategorie[droitData[0]]}</h2>
                <div className="grid grid-cols-4 gap-4">
                  {droitData[1].map((droit) => (
                    <Card key={droit._id}>
                      <CardHeader>
                        <div className={"flex justify-between"}>
                          <CardTitle>{droit.name.split(" - ")[2]}</CardTitle>
                          <input
                            type={"checkbox"}
                            onChange={() =>
                              updateDroit(
                                droit._id,
                                currentRole._id,
                                !droit.active,
                              )
                            }
                            checked={droit.active}
                          ></input>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <p className={"capitalize"}>
                          {droit.description ?? "Description à implémenter"}
                        </p>
                      </CardContent>
                    </Card>
                  ))}
                </div>
              </div>
            ))
          : "Chargement..."}
      </div>
      {/*{infos.length > 0 ? (*/}
      {/*  <div>*/}
      {/*    <h2>Informations</h2>*/}
      {/*    <div>*/}
      {/*      <Card>*/}
      {/*        <CardContent>*/}
      {/*          {infos.map((info, key) => (*/}
      {/*            <p key={key}>{info}</p>*/}
      {/*          ))}*/}
      {/*        </CardContent>*/}
      {/*      </Card>*/}
      {/*    </div>*/}
      {/*  </div>*/}
      {/*) : (*/}
      {/*  ""*/}
      {/*)}*/}
    </div>
  );
}

export default Permissions;
